version: '3.8'

services:
  # ============================================================================
  # Streamlit Web Application
  # ============================================================================
  web:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tagsense-web
    ports:
      - "8501:8501"
    environment:
      # AWS Configuration
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - AWS_REGIONS=${AWS_REGIONS:-us-east-1,us-west-2}
      - AWS_PROFILE=${AWS_PROFILE:-default}

      # LLM Configuration
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - LLM_PRIMARY_BACKEND=${LLM_PRIMARY_BACKEND:-openai}
      - LLM_FALLBACK_BACKEND=${LLM_FALLBACK_BACKEND:-anthropic}
      - OPENAI_MODEL=${OPENAI_MODEL:-gpt-3.5-turbo}
      - ANTHROPIC_MODEL=${ANTHROPIC_MODEL:-claude-3-5-sonnet-20241022}

      # Application Settings
      - DEBUG=${DEBUG:-false}
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - ENABLE_CACHE=${ENABLE_CACHE:-true}

      # Neo4j Graph Database
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-tagsense123}

      # Redis Cache
      - REDIS_HOST=redis
      - REDIS_PORT=6379

      # InfluxDB Time Series
      - INFLUXDB_URL=http://influxdb:8086
      - INFLUXDB_TOKEN=${INFLUXDB_TOKEN:-tagsense-admin-token}
      - INFLUXDB_ORG=tagsense
      - INFLUXDB_BUCKET=compliance_metrics

    volumes:
      # Mount AWS credentials (read-only for security)
      - ~/.aws:/home/tagsense/.aws:ro
      # Persistent data
      - tagsense-data:/app/data
      - tagsense-logs:/app/logs
    depends_on:
      - neo4j
      - redis
      - influxdb
    networks:
      - tagsense-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8501/_stcore/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # FastAPI REST API Server
  # ============================================================================
  api:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: tagsense-api
    command: ["uvicorn", "api.main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
    ports:
      - "8000:8000"
    environment:
      # Same environment as web app
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION:-us-east-1}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - NEO4J_URI=bolt://neo4j:7687
      - NEO4J_USER=neo4j
      - NEO4J_PASSWORD=${NEO4J_PASSWORD:-tagsense123}
      - REDIS_HOST=redis
      - REDIS_PORT=6379
    volumes:
      - ~/.aws:/home/tagsense/.aws:ro
      - tagsense-data:/app/data
    depends_on:
      - neo4j
      - redis
      - influxdb
    networks:
      - tagsense-network
    restart: unless-stopped

  # ============================================================================
  # Neo4j Graph Database
  # ============================================================================
  neo4j:
    image: neo4j:5.15-community
    container_name: tagsense-neo4j
    ports:
      - "7474:7474"  # HTTP
      - "7687:7687"  # Bolt
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-tagsense123}
      - NEO4J_PLUGINS=["apoc", "graph-data-science"]
      - NEO4J_dbms_memory_heap_max__size=2G
      - NEO4J_dbms_memory_pagecache_size=1G
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs
    networks:
      - tagsense-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "cypher-shell", "-u", "neo4j", "-p", "${NEO4J_PASSWORD:-tagsense123}", "RETURN 1"]
      interval: 10s
      timeout: 10s
      retries: 5
      start_period: 30s

  # ============================================================================
  # Redis Cache
  # ============================================================================
  redis:
    image: redis:7-alpine
    container_name: tagsense-redis
    ports:
      - "6379:6379"
    command: redis-server --appendonly yes --maxmemory 512mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - tagsense-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # InfluxDB Time Series Database
  # ============================================================================
  influxdb:
    image: influxdb:2.7-alpine
    container_name: tagsense-influxdb
    ports:
      - "8086:8086"
    environment:
      - DOCKER_INFLUXDB_INIT_MODE=setup
      - DOCKER_INFLUXDB_INIT_USERNAME=admin
      - DOCKER_INFLUXDB_INIT_PASSWORD=${INFLUXDB_PASSWORD:-tagsense-admin-pass}
      - DOCKER_INFLUXDB_INIT_ORG=tagsense
      - DOCKER_INFLUXDB_INIT_BUCKET=compliance_metrics
      - DOCKER_INFLUXDB_INIT_ADMIN_TOKEN=${INFLUXDB_TOKEN:-tagsense-admin-token}
    volumes:
      - influxdb-data:/var/lib/influxdb2
      - influxdb-config:/etc/influxdb2
    networks:
      - tagsense-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "influx", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ============================================================================
  # Grafana Dashboard (Optional - for visualization)
  # ============================================================================
  grafana:
    image: grafana/grafana:10.2.0
    container_name: tagsense-grafana
    ports:
      - "3000:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_INSTALL_PLUGINS=grafana-neo4j-datasource
    volumes:
      - grafana-data:/var/lib/grafana
      - ./deployment/grafana/dashboards:/etc/grafana/provisioning/dashboards
      - ./deployment/grafana/datasources:/etc/grafana/provisioning/datasources
    depends_on:
      - influxdb
      - neo4j
    networks:
      - tagsense-network
    restart: unless-stopped

  # ============================================================================
  # nginx Reverse Proxy
  # ============================================================================
  nginx:
    image: nginx:alpine
    container_name: tagsense-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/nginx/ssl:/etc/nginx/ssl:ro
    depends_on:
      - web
      - api
      - grafana
    networks:
      - tagsense-network
    restart: unless-stopped

# ============================================================================
# Networks
# ============================================================================
networks:
  tagsense-network:
    driver: bridge
    name: tagsense-network

# ============================================================================
# Volumes for Data Persistence
# ============================================================================
volumes:
  tagsense-data:
    name: tagsense-data
  tagsense-logs:
    name: tagsense-logs
  neo4j-data:
    name: neo4j-data
  neo4j-logs:
    name: neo4j-logs
  redis-data:
    name: redis-data
  influxdb-data:
    name: influxdb-data
  influxdb-config:
    name: influxdb-config
  grafana-data:
    name: grafana-data
